# ========================================
# Snort Configuration File
# ========================================
# LEARNING: This is the main Snort configuration
# It defines what to monitor and how to alert
#
# Key sections:
# 1. Network variables
# 2. Decoder and preprocessor config
# 3. Output plugins
# 4. Rule files to include
# ========================================

# ========================================
# SECTION 1: Network Variables
# ========================================
# LEARNING: Define your network topology
# This helps Snort understand what's "inside" vs "outside"

# Define your internal network
# LEARNING: HOME_NET is what you're protecting
var HOME_NET any

# Define external network
# LEARNING: EXTERNAL_NET is where attacks come from
var EXTERNAL_NET any

# Define DMZ (if you have one)
var DMZ_NET any

# HTTP servers
var HTTP_SERVERS $HOME_NET
var HTTP_PORTS [80,443,8080,8443]

# SQL servers
var SQL_SERVERS $HOME_NET
var SQL_PORTS [1433,1434,3306,5432]

# SSH servers
var SSH_SERVERS $HOME_NET
var SSH_PORTS 22

# FTP servers
var FTP_SERVERS $HOME_NET
var FTP_PORTS 21

# SIP servers (VoIP)
var SIP_SERVERS $HOME_NET
var SIP_PORTS [5060,5061]

# ========================================
# SECTION 2: Paths
# ========================================
var RULE_PATH /etc/snort/rules
var SO_RULE_PATH /etc/snort/so_rules
var PREPROC_RULE_PATH /etc/snort/preproc_rules
var WHITE_LIST_PATH /etc/snort/rules
var BLACK_LIST_PATH /etc/snort/rules

# ========================================
# SECTION 3: Decoder Configuration
# ========================================
# LEARNING: Configure how Snort decodes protocols

# Stop generic decode events
config disable_decode_alerts

# Stop TCP stream reassembly alerts
config disable_tcpopt_experimental_alerts
config disable_tcpopt_obsolete_alerts
config disable_tcpopt_ttcp_alerts

# Enable MAC address logging
config show_year

# Configure detection engine
# LEARNING: This affects performance and accuracy
config detection: search-method ac-split search-optimize max-pattern-len 20

# Configure event queue
# LEARNING: How many alerts to buffer before processing
config event_queue: max_queue 8 log 5 order_events content_length

# ========================================
# SECTION 4: Preprocessors
# ========================================
# LEARNING: Preprocessors normalize and decode traffic
# before rules are applied

# Normalize HTTP traffic
# LEARNING: Attackers use encoding to evade detection
# This preprocessor normalizes various encodings
preprocessor http_inspect: global iis_unicode_map unicode.map 1252 compress_depth 65535 decompress_depth 65535

preprocessor http_inspect_server: server default \
    profile all \
    ports { 80 443 8080 8443 } \
    server_flow_depth 0 \
    client_flow_depth 0 \
    post_depth 65495 \
    oversize_dir_length 500 \
    max_header_length 750 \
    max_headers 100 \
    enable_cookie \
    extended_response_inspection \
    inspect_gzip \
    normalize_utf \
    unlimited_decompress

# FTP/Telnet normalization
preprocessor ftp_telnet: global inspection_type stateful encrypted_traffic no check_encrypted

preprocessor ftp_telnet_protocol: telnet \
    ayt_attack_thresh 20 \
    normalize ports { 23 } \
    detect_anomalies

preprocessor ftp_telnet_protocol: ftp server default \
    def_max_param_len 100 \
    ports { 21 } \
    ftp_cmds { USER PASS ACCT CWD CDUP SMNT QUIT REIN PORT PASV TYPE STRU MODE } \
    alt_max_param_len 0 { } \
    chk_str_fmt { USER PASS RNFR RNTO SITE MKD } \
    cmd_validity MODE < char ASBCZ >

# SSH detection
# LEARNING: Detect SSH version scanning, brute force
preprocessor ssh: server_ports { 22 2222 } \
    autodetect \
    max_client_bytes 19600 \
    max_encrypted_packets 20 \
    max_server_version_len 100 \
    enable_respoverflow enable_ssh1crc32 \
    enable_srvoverflow enable_protomismatch

# DNS preprocessor
# LEARNING: Detect DNS tunneling, cache poisoning
preprocessor dns: ports { 53 } enable_rdata_overflow

# SSL/TLS preprocessor
# LEARNING: Inspect encrypted traffic metadata
preprocessor ssl: ports { 443 465 563 636 989 992 993 994 995 7801 7802 7900 7901 7902 7903 7904 7905 7906 7907 7908 7909 7910 7911 7912 7913 7914 7915 7916 7917 7918 7919 7920 }, trustservers, noinspect_encrypted

# Portscan detection
# LEARNING: Critical for detecting reconnaissance
# Alerts when single IP scans multiple ports
preprocessor sfportscan: proto { all } \
    memcap { 10000000 } \
    sense_level { medium } \
    scan_type { all }

# Stream5 preprocessor (TCP reassembly)
# LEARNING: Reassembles TCP streams to detect attacks
# that span multiple packets
preprocessor stream5_global: track_tcp yes, \
    track_udp yes, \
    track_icmp no, \
    max_tcp 262144, \
    max_udp 131072, \
    max_active_responses 2, \
    min_response_seconds 5

preprocessor stream5_tcp: policy windows, detect_anomalies, require_3whs 180, \
    overlap_limit 10, small_segments 3 bytes 150, timeout 180, \
    ports client 21 22 23 25 42 53 79 109 110 111 113 119 135 136 137 139 143 \
        161 445 513 514 587 593 691 1433 1521 1741 2100 3306 6070 6665 6666 6667 6668 6669 \
        7000 8181 32770 32771 32772 32773 32774 32775 32776 32777 32778 32779, \
    ports both 80 443 465 563 636 989 992 993 994 995 1220 7801 7802 7900 7901 7902 7903 7904 7905 7906 7907 7908 7909 7910 7911 7912 7913 7914 7915 7916 7917 7918 7919 7920

preprocessor stream5_udp: timeout 180

# ========================================
# SECTION 5: Output Plugins
# ========================================
# LEARNING: Where to send alerts

# Unified2 output (binary format)
# LEARNING: Efficient format for high-volume logging
output unified2: filename snort.log, limit 128

# Alert to syslog
output alert_syslog: LOG_AUTH LOG_ALERT

# Alert to file in unified2 format
# LEARNING: This is what Filebeat will process
output alert_fast: /var/log/snort/alert.log
output unified2: filename snort.log, limit 128

# ========================================
# SECTION 6: Rule Files
# ========================================
# LEARNING: Include rule files here
# Each rule file focuses on specific attack types

# Local rules (our custom rules)
include $RULE_PATH/local.rules

# Community rules
include $RULE_PATH/community.rules

# Emerging Threats (if downloaded)
# include $RULE_PATH/emerging-threats.rules

# ========================================
# LEARNING: Snort Rule Anatomy
# ========================================
# Example rule:
# alert tcp $EXTERNAL_NET any -> $HOME_NET 22 (msg:"SSH Brute Force"; \
#   flow:to_server,established; detection_filter:track by_src, count 5, seconds 60; \
#   sid:1000001; rev:1;)
#
# Breakdown:
# - alert: Action (alert, log, pass, drop, reject)
# - tcp: Protocol
# - $EXTERNAL_NET any: Source IP/port
# - ->: Direction
# - $HOME_NET 22: Destination IP/port
# - msg: Human-readable message
# - flow: Connection state tracking
# - detection_filter: Alert only if condition met
# - sid: Unique rule ID (1000000+ for local rules)
# - rev: Rule revision
# ========================================
